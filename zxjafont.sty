%%
%% This is file 'zxjafont.sty'.
%%
%% Copyright (c) 2009-2020 Takayuki YATO (aka. "ZR")
%%   GitHub:   https://github.com/zr-tex8r
%%   Twitter:  @zr_tex8r
%%
%% This package is distributed under the MIT License.
%%

%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{zxjafont}[2020/01/12 v0.7-pre]
\def\zxjf@pkgname{zxjafont}

%% preparation
\RequirePackage{ifxetex}\RequireXeTeX
\providecommand{\bxDebug}[1]{}

%--------------------------------------- general

%% packages
\RequirePackage{fontspec}
\RequirePackage{keyval}
\RequirePackage{etoolbox}[2011/01/03]% v2.1

%% errors
\def\zxjf@err@ivval#1#2{%
  \PackageError\zxjf@pkgname
   {Invalid value '#2' for option #1}\@ehc}

%% \zxjf@cond\ifXXX...\fi{<true>}{<false>}
\@gobbletwo\if\if \def\zxjf@cond#1\fi{%
  #1\expandafter\@firstoftwo\else\expandafter\@secondoftwo\fi}

%% \zxjf@with@cs\CS{<csname>}
\def\zxjf@with@cs#1#2{%
  \expandafter#1\csname#2\endcsname}

%% \zxjf@onlypreamble@def\CS
\def\zxjf@onlypreamble@def#1{%
  \@onlypreamble#1\def#1}
%% \zxjf@onlypreamble@let\CS
\def\zxjf@onlypreamble@let#1{%
  \@onlypreamble#1\let#1}

%% \if\zxjf@isvalid{<csname>}...\fi
\def\zxjf@isvalid#1{%
  \ifcsvoid{#1}{F}{T}T}

%--------------------------------------- handle options

%% constants
\chardef\zxjf@cjkshape@@none=0
\chardef\zxjf@cjkshape@@xc=1    % 90jis
\chardef\zxjf@cjkshape@@mmiv=2  % jis2004

%% variables
\let\zxjf@main@preset\relax
\let\zxjf@sub@preset\@empty
\newif\ifzxjf@prop
\newif\ifzxjf@oneweight
\let\zxjf@cjkshape\zxjf@cjkshape@@none
\let\zxjf@scale\relax
\let\zxjf@feature\@empty
\newif\ifzxjf@zxjatype

%% \zxjf@all@main@preset
\zxjf@onlypreamble@def\zxjf@all@main@preset{%
  %(uniweight)
  ms,ipa,ipaex,%
  %(multiweight)
  ms-hg,ipa-hg,ipaex-hg,moga,moga-90,ume,%
  kozuka-pro,kozuka-pr6,kozuka-pr6n,hiragino-pro,hiragino-pron,%
  morisawa-pro,morisawa-pr6n,yu-win,yu-win10,yu-osx,%
  sourcehan,sourcehan-jp,noto,noto-jp,haranoaji,%
  %(alias)
  kozuka,morisawa,moga-mobo-ex,noto-otf,hiragino}

%% \zxjf@all@sub@preset
\zxjf@onlypreamble@def\zxjf@all@sub@preset{%
  hg,hiraginomg-pro,hiraginomg-pron,mobo,mobo-90,maruberi,%
  hiraginomg}

% preset options
\def\zxjf@do#1{\DeclareOption{#1}{\def\zxjf@main@preset{#1}}}
\@for\zxjf@x:=\zxjf@all@main@preset\do{%
  \expandafter\zxjf@do\expandafter{\zxjf@x}}
\def\zxjf@do#1{\DeclareOption{#1}{\appto\zxjf@sub@preset{#1,}}}
\@for\zxjf@x:=\zxjf@all@sub@preset\do{%
  \expandafter\zxjf@do\expandafter{\zxjf@x}}
% 'prop'
\DeclareOption{prop}{\zxjf@proptrue}
\DeclareOption{noprop}{\zxjf@propfalse}
% 'oneweight'
\DeclareOption{oneweight}{\zxjf@oneweighttrue}
\DeclareOption{nooneweight}{\zxjf@oneweightfalse}
% '90jis'/'jis2004'
\DeclareOption{jis90}{\let\zxjf@cjkshape\zxjf@cjkshape@@xc}
\DeclareOption{90jis}{\let\zxjf@cjkshape\zxjf@cjkshape@@xc}
\DeclareOption{jis2004}{\let\zxjf@cjkshape\zxjf@cjkshape@@mmiv}
\DeclareOption{2004jis}{\let\zxjf@cjkshape\zxjf@cjkshape@@mmiv}

% abolished presets
\zxjf@onlypreamble@def\zxjf@err@abpre#1{%
  \PackageError\zxjf@pkgname
   {The old preset '#1' is *abolished*}{\@ehc}}
\@for\zxjf@x:={%
  kozuka4,kozuka6,kozuka6n,ms-dx,ipa-dx,hiragino-dx%
}\do{\DeclareOption{\zxjf@x}{\zxjf@err@abpre{\CurrentOption}}}

%% options using keyval
\DeclareOption*{\def\zxjf@do{\setkeys{zxjf}}%
  \expandafter\zxjf@do\expandafter{\CurrentOption}}
% 'scale=<real>'
\define@key{zxjf}{scale}{\def\zxjf@scale{#1}}
% 'feature=<text>'
\define@key{zxjf}{feature}{\def\zxjf@feature{#1}}

%% dispatch
\zxjf@onlypreamble@let\zxjf@org@use@ption\@use@ption
\def\@use@ption{\csname ds@\CurrentOption \endcsname}% FIXME
\ProcessOptions*
\let\@use@ption\zxjf@org@use@ption

%% preset must be given
\ifx\zxjf@main@preset\relax
  \PackageError\zxjf@pkgname
   {Preset name not specified}
   {You must give one of the following names as option.\MessageBreak
    \space\space\zxjf@all@main@preset}
\expandafter\endinput\fi\relax

%% detect zxjatype
\@ifpackageloaded{zxjatype}{\zxjf@zxjatypetrue}{}
\AtBeginDocument{%
  \unless\ifzxjf@zxjatype
    \@ifpackageloaded{zxjatype}{%
      \PackageError\zxjf@pkgname
       {zxjatype must be loaded before me}\@ehc
    }{}%
  \fi}
\ifzxjf@zxjatype\ifzxjf@prop
  \PackageError\zxjf@pkgname
   {Option 'prop' cannot be used with zxjatype}\@ehc
  \zxjf@propfalse
\fi\fi

%% decide scale factor
\ifx\zxjf@scale\relax
  % If zxjatype is used, try \JaFontScale, \zxjt@scale,
  % and \__zxjt_scale_tl.
  \ifzxjf@zxjatype
    \ifdefined\JaFontScale \let\zxjf@scale\JaFontScale
    \else\if\zxjf@isvalid{zxjt@scale}\let\zxjf@scale\zxjt@scale
    \else\if\zxjf@isvalid{__zxjt_scale_tl}%
      \letcs\zxjf@scale{__zxjt_scale_tl}
    \fi\fi\fi
  \fi
  \ifx\zxjf@scale\relax % still unknown
    % Try \Cjascale and \jsScale.
    \ifdefined\Cjascale \let\zxjf@scale\Cjascale
    \else\ifdefined\jsScale \let\zxjf@scale\jsScale
    \fi\fi
  \fi
  \ifx\zxjf@scale\relax % still unknown
    \def\zxjf@scale{1}%
  \fi
\fi

%% \zxjf@whole@feature
% All fontspec options including scale.
\edef\zxjf@whole@feature{%
  Scale=\zxjf@scale
  % CJKShape
  \ifcase\zxjf@cjkshape % none
  \or ,CJKShape=JIS1990% 90jis
  \or ,CJKShape=JIS2004% jis2004
  \fi
  \ifdefined\zxjafontFeature
    ,\expandonce\zxjafontFeature
  \fi
  \unless\ifx\zxjf@feature\@empty
    ,\expandonce\zxjf@feature
  \fi}
\bxDebug{zxjafont>>scale=\zxjf@scale/feat={\zxjf@whole@feature}/%
  preset=\zxjf@main@preset/\zxjf@sub@preset}

%--------------------------------------- font setup helpers

%% \zxjf@font@set
\zxjf@onlypreamble@def\zxjf@font@set#1#2{%
  \noexpand#1[\expandonce\zxjf@whole@feature,#2]}
%% \zxjf@newfamily@gen\CSnewjafamily
\@onlypreamble\zxjf@newfamily@gen\edef\zxjf@newfamily@gen{%
  \noexpand\zxjf@newfamily@gen@a
      {\expandonce\zxjf@feature}{\expandonce\zxjf@whole@feature}}
\zxjf@onlypreamble@def\zxjf@newfamily@gen@a#1#2#3{%
  \def\zxjf@newfamily##1##2##3{%
    \csedef{##1family}{%
      \expandonce{\csname a##1family\endcsname}\noexpand\CJKfamily{##1}}%
    \zxjf@with@cs\newfontfamily{a##1family}[#1,##2]{##3}%
    #3{##1}[#2,##2]{##3}}}

%% \zxjf@setmainfont{<attributes>}{<fam_name>}, etc.
\ifzxjf@zxjatype
\edef\zxjf@setmainfont#1{\zxjf@font@set\setjamainfont{#1}}
\edef\zxjf@setsansfont#1{\zxjf@font@set\setjasansfont{#1}}
\edef\zxjf@setmonofont#1{\zxjf@font@set\setjamonofont{#1}}
\zxjf@newfamily@gen{\setjafamilyfont}
\else
\edef\zxjf@setmainfont#1{\zxjf@font@set\setmainfont{#1}}
\edef\zxjf@setsansfont#1{\zxjf@font@set\setsansfont{#1}}
\edef\zxjf@setmonofont#1{\zxjf@font@set\setmonofont{#1}}
\edef\zxjf@newfamily#1#2{%
  \unexpanded{\zxjf@with@cs\newfontfamily}{#1family}%
      [\expandonce\zxjf@whole@feature,#2]}
\fi

%--------------------------------------- preset japanese font mappings

%% \zxjf@declare@preset{<name>}{<text>}, etc.
\zxjf@onlypreamble@def\zxjf@declare@preset#1{%
  \zxjf@with@cs\zxjf@onlypreamble@def{zxjf@the@preset@#1}}
\zxjf@declare@preset{}{}
\zxjf@onlypreamble@def\zxjf@uniweight#1#2#3{%
  \zxjf@setmainfont{#3,BoldFont=#2}{#1}%
  \zxjf@setsansfont{#3,BoldFont=#2}{#2}%
  \zxjf@setmonofont{#3,BoldFont=#2}{#2}}
\zxjf@onlypreamble@def\zxjf@multiweight#1#2#3#4#5#6{%
  \ifzxjf@oneweight
    \zxjf@setmainfont{#6,BoldFont=#5}{#1}%
    \zxjf@setsansfont{#6,BoldFont=#5}{#5}%
    \zxjf@setmonofont{#6,BoldFont=#5}{#5}%
  \else
    \zxjf@setmainfont{#6,BoldFont=#2}{#1}%
    \zxjf@setsansfont{#6,BoldFont=#4}{#3}%
    \zxjf@setmonofont{#6,BoldFont=#4}{#3}%
  \fi}
%% \zxjf@declare@preset@with@prop{<name>}{<text>}
\zxjf@onlypreamble@def\zxjf@declare@preset@with@prop#1#2{%
  \zxjf@declare@preset{#1}{#2{RawFeature=-palt;-kern}}%
  \zxjf@declare@preset{#1/prop}{#2{RawFeature=+palt;+kern}}}

%% \zxjf@declare@preset@alias{<name1>}{<name2>}
\zxjf@onlypreamble@def\zxjf@declare@preset@alias#1#2{%
  \zxjf@with@cs\@onlypreamble{zxjf@the@preset@#1}%
  \csletcs{zxjf@the@preset@#1}{zxjf@the@preset@#2}}
%% \zxjf@declare@preset@alias@with@prop{<name1>}{<name2>}
\zxjf@onlypreamble@def\zxjf@declare@preset@alias@with@prop#1#2{%
  \zxjf@declare@preset@alias{#1}{#2}%
  \zxjf@declare@preset@alias{#1/prop}{#2/prop}}

%% \zxjf@use@preset{<name>}
\zxjf@onlypreamble@def\zxjf@use@preset#1{%
  \undef\zxjf@do
  \ifzxjf@prop \letcs\zxjf@do{zxjf@the@preset@#1/prop}\fi
  \unless\ifdefined\zxjf@do \letcs\zxjf@do{zxjf@the@preset@#1}\fi
  \zxjf@do}

%% definitions of main preset mappings
\zxjf@declare@preset{ms}{%
  \zxjf@uniweight{MS-Mincho}{MS-Gothic}{}}
\zxjf@declare@preset{ms/prop}{%
  \zxjf@uniweight{MS-PMincho}{MS-PGothic}{}}
\zxjf@declare@preset{ms-hg}{%
  \zxjf@multiweight{MS-Mincho}{HGMinchoE}%
    {HGGothicM}{HGGothicE}{MS-Gothic}{}}
\zxjf@declare@preset{ms-hg/prop}{%
  \zxjf@multiweight{MS-PMincho}{HGPMinchoE}%
    {HGPGothicM}{HGGothicE}{MS-PGothic}{}}
\zxjf@declare@preset{ipa}{%
  \zxjf@uniweight{IPAMincho}{IPAGothic}{}}
\zxjf@declare@preset{ipa/prop}{%
  \zxjf@uniweight{IPAPMincho}{IPAPGothic}{}}
\zxjf@declare@preset{ipa-hg}{%
  \zxjf@multiweight{IPAMincho}{HGMinchoE}%
    {HGGothicM}{HGGothicE}{IPAGothic}{}}
\zxjf@declare@preset{ipa-hg/prop}{%
  \zxjf@multiweight{IPAPMincho}{HGPMinchoE}%
    {HGPGothicM}{HGGothicE}{IPAPGothic}{}}
\zxjf@declare@preset{ipaex}{%
  \zxjf@uniweight{ipaexm.ttf}{ipaexg.ttf}{}}
\zxjf@declare@preset{ipaex-hg}{%
  \zxjf@multiweight{ipaexm.ttf}{HGSMinchoE}%
    {HGSGothicM}{HGSGothicE}{ipaexg.ttf}{}}
\zxjf@declare@preset{moga}{%
  \zxjf@multiweight{MogaExMincho}{MogaExMincho Bold}%
    {MogaExGothic}{MogaExGothic Bold}{MogaExGothic}{}}
\zxjf@declare@preset{moga-90}{%
  \zxjf@multiweight{MogaEx90Mincho}{MogaEx90Mincho Bold}%
    {MogaEx90Gothic}{MogaEx90Gothic Bold}{MogaEx90Gothic}{}}
\zxjf@declare@preset{ume}{%
  \zxjf@multiweight{Ume Mincho}{Ume Mincho}%
    {Ume Gothic}{Ume Gothic O5}{Ume Gothic O5}{}}
\zxjf@declare@preset@with@prop{kozuka-pro}{%
  \zxjf@multiweight{KozMinPro-Regular}{KozMinPro-Bold}%
    {KozGoPro-Regular}{KozGoPro-Bold}%
    {KozGoPro-Medium}}
\zxjf@declare@preset@with@prop{kozuka-pr6}{%
  \zxjf@multiweight{KozMinProVI-Regular}{KozMinProVI-Bold}%
    {KozGoProVI-Regular}{KozGoProVI-Bold}%
    {KozGoProVI-Medium}}
\zxjf@declare@preset@with@prop{kozuka-pr6n}{%
  \zxjf@multiweight{KozMinPr6N-Regular}{KozMinPr6N-Bold}%
    {KozGoPr6N-Regular}{KozGoPr6N-Bold}%
    {KozGoPr6N-Medium}}
\zxjf@declare@preset@with@prop{hiragino-pro}{%
  \zxjf@multiweight{Hiragino Mincho Pro W3}{Hiragino Mincho Pro W6}%
    {Hiragino Kaku Gothic Pro W3}{Hiragino Kaku Gothic Pro W6}%
    {Hiragino Kaku Gothic Pro W6}}
\zxjf@declare@preset@with@prop{hiragino-pron}{%
  \zxjf@multiweight{Hiragino Mincho ProN W3}{Hiragino Mincho ProN W6}%
    {Hiragino Kaku Gothic ProN W3}{Hiragino Kaku Gothic ProN W6}%
    {Hiragino Kaku Gothic ProN W6}}
\zxjf@declare@preset@with@prop{morisawa-pro}{%
  \zxjf@multiweight{A-OTF-RyuminPro-Light.otf}{A-OTF-FutoMinA101Pro-Bold.otf}%
    {A-OTF-GothicBBBPro-Medium.otf}{A-OTF-FutoGoB101Pro-Bold.otf}%
    {A-OTF-GothicBBBPro-Medium.otf}}
\zxjf@declare@preset@with@prop{morisawa-pr6n}{%
  \zxjf@multiweight{A-OTF-RyuminPr6N-Light.otf}{A-OTF-FutoMinA101Pr6N-Bold.otf}%
    {A-OTF-GothicBBBPr6N-Medium.otf}{A-OTF-FutoGoB101Pr6N-Bold.otf}%
    {A-OTF-GothicBBBPr6N-Medium.otf}}
\zxjf@declare@preset@with@prop{yu-win}{%
  \zxjf@multiweight{YuMincho-Regular}{YuMincho-Demibold}%
    {YuGothic-Regular}{YuGothic-Bold}%
    {YuGothic-Regular}}
\zxjf@declare@preset@with@prop{yu-win10}{%
  \zxjf@multiweight{YuMincho-Regular}{YuMincho-Demibold}%
    {YuGothic-Regular}{YuGothic-Bold}%
    {YuGothic-Medium}}
\zxjf@declare@preset@with@prop{yu-osx}{%
  \zxjf@multiweight{YuMincho-Medium}{YuMincho-Demibold}%
    {YuGothic-Medium}{YuGothic-Bold}%
    {YuGothic-Medium}}
\zxjf@declare@preset@with@prop{sourcehan}{%
  \zxjf@multiweight{SourceHanSerif-Regular}{SourceHanSerif-Bold}%
    {SourceHanSans-Regular}{SourceHanSans-Bold}%
    {SourceHanSans-Medium}}
\zxjf@declare@preset@with@prop{sourcehan-jp}{%
  \zxjf@multiweight{SourceHanSerifJP-Regular}{SourceHanSerifJP-Bold}%
    {SourceHanSansJP-Regular}{SourceHanSansJP-Bold}%
    {SourceHanSansJP-Medium}}
\zxjf@declare@preset@with@prop{noto}{%
  \zxjf@multiweight{NotoSerifCJKjp-Regular}{NotoSerifCJKjp-Bold}%
    {NotoSansCJKjp-Regular}{NotoSansCJKjp-Bold}%
    {NotoSansCJKjp-Medium}}
\zxjf@declare@preset@with@prop{noto-jp}{%
  \zxjf@multiweight{NotoSerifJP-Regular}{NotoSerifJP-Bold}%
    {NotoSansJP-Regular}{NotoSansJP-Bold}%
    {NotoSansJP-Medium}}
\zxjf@declare@preset@with@prop{haranoaji}{%
  \zxjf@multiweight{HaranoAjiMincho-Regular}{HaranoAjiMincho-Bold}%
    {HaranoAjiGothic-Regular}{HaranoAjiGothic-Bold}%
    {HaranoAjiGothic-Medium}}
%(alias)
\zxjf@declare@preset@alias@with@prop{kozuka}{kozuka-pro}
\zxjf@declare@preset@alias@with@prop{morisawa}{morisawa-pro}
\zxjf@declare@preset@alias{moga-mobo-ex}{moga}
\zxjf@declare@preset@alias@with@prop{noto-otf}{noto}
\zxjf@declare@preset@alias@with@prop{hiragino}{hiragino-pro}

%% \zxjf@declare@sub@preset@nf@with@prop{<name>}{<fam>}{<font>}
\zxjf@onlypreamble@def\zxjf@declare@sub@preset@nf@with@prop#1#2#3{%
  \zxjf@declare@preset{#1}{\zxjf@newfamily{#2}{RawFeature=-palt;-kern}{#3}}%
  \zxjf@declare@preset{#1/prop}{\zxjf@newfamily{#2}{RawFeature=+palt;+kern}{#3}}}
%% definitions of sub preset mappings
\zxjf@declare@preset{hg}{%
  \zxjf@newfamily{hgmc}{BoldFont=HGSMinchoE}{HGSMinchoB}%
  \zxjf@newfamily{hgpr}{}{HGSSoeiPresenceEB}%
  \zxjf@newfamily{hggt}{BoldFont=HGSGothicE}{HGSGothicM}%
  \zxjf@newfamily{hggu}{}{HGSSoeiKakugothicUB}%
  \zxjf@newfamily{hgmg}{}{HGMaruGothicMPRO}%
  \zxjf@newfamily{hgkk}{}{HGSKyokashotai}%
  \zxjf@newfamily{hgks}{}{HGSeikaishotaiPRO}%
  \zxjf@newfamily{hggs}{}{HGSGyoshotai}%
  \zxjf@newfamily{hgpp}{}{HGSSoeiKakupoptai}%
}
\zxjf@declare@preset{hg/prop}{%
  \zxjf@newfamily{hgmc}{BoldFont=HGPMinchoE}{HGPMinchoB}%
  \zxjf@newfamily{hgpr}{}{HGPSoeiPresenceEB}%
  \zxjf@newfamily{hggt}{BoldFont=HGPGothicE}{HGPGothicM}%
  \zxjf@newfamily{hggu}{}{HGPSoeiKakugothicUB}%
  \zxjf@newfamily{hgmg}{}{HGMaruGothicMPRO}%
  \zxjf@newfamily{hgkk}{}{HGPKyokashotai}%
  \zxjf@newfamily{hgks}{}{HGSeikaishotaiPRO}%
  \zxjf@newfamily{hggs}{}{HGPGyoshotai}%
  \zxjf@newfamily{hgpp}{}{HGPSoeiKakupoptai}%
}
\zxjf@declare@sub@preset@nf@with@prop{hiraginomg-pro}%
  {hmg}{Hiragino Maru Gothic Pro W4}
\zxjf@declare@sub@preset@nf@with@prop{hiraginomg-pron}%
  {hmg}{Hiragino Maru Gothic ProN W4}
\zxjf@declare@preset@alias@with@prop{hiraginomg}{hiraginomg-pro}

\zxjf@declare@preset{mobo}{%
  \zxjf@newfamily{mobo}{BoldFont=MoboExGothic Bold}{MoboExGothic}}
\zxjf@declare@preset{mobo-90}{%
  \zxjf@newfamily{mobo}{BoldFont=MoboEx90Gothic Bold}{MoboEx90Gothic}}
\zxjf@declare@preset{maruberi}{%
  \zxjf@newfamily{mmg}{}{MotoyaLMaru}}

%% ... and invokes the specified one!
\zxjf@use@preset{\zxjf@main@preset}
\@for\zxjf@x:=\zxjf@sub@preset\do{\zxjf@use@preset\zxjf@x}

%--------------------------------------- and some extras

%%<*> \useeasyjapanesesettings
\newcommand*\useeasyjapanesesettings{%
\XeTeXlinebreaklocale "ja"\relax
\XeTeXlinebreakskip=0pt plus 1pt minus 0.1pt\relax
\XeTeXlinebreakpenalty=0\relax
}

%--------------------------------------- all done
\endinput
%% EOF
